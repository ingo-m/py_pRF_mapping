#####################################
### Upload package update to pypi ###
#####################################

# Install pandoc (if you don't have it yet):
conda install -c conda-forge pandoc

# Install twine (if you don't have it yet):
pip install twine

# Checkout devel branch.
git checkout devel

# Make changes to code.

# Check existing tags and decide on a sensible new tag.
git tag

# Update setup.py file (update pypi version badge, e.g. text replacement
# '1.3.6' -> '1.3.7' - without the 'v' prefix, because version='1.3.7').

# Add and commit:
git add .
git commit -m "New version tag."

# Push changes:
git push origin devel

# Merge changes from devel to master:
git checkout master
git merge devel -m "Merge changes from devel. New tag for pypi."

# Create new tag, e.g.:
git tag v1.3.7 -m "New pypi tag."
git push origin master --follow-tags

# Through the github web interface, turn the tag into a release. The purpose of
# this is for zenodo to become aware of the changes (the zenodo webhook is
# configured to follow releases).

# Wait a few minutes for zenodo to update to the new version. Copy the new
# version DOI from zenodo, and replace the old one in the `readme.md` file
# (i.e. update both occurences in the following line, in this case the number
# '1220207' needs to be updated):
# [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.1220207.svg)](https://doi.org/10.5281/zenodo.1220207)

# Update readme.rst:
pandoc --from=markdown --to=rst --output=README.rst README.md

# Commit and push changes:
git add .
git commit -m "Updated DOI."
git push origin master

# Upload the package update to pypi:
# python setup.py sdist upload -r pypi <-- old way
python setup.py sdist
twine upload dist/*

# Switch back to devel branch:
git checkout devel

# Merge changes from master:
git merge master -m "Merge changes from master."
git push origin devel
